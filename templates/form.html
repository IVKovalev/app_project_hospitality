<!DOCTYPE html>
<html>
<head>
    <title>Form</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <meta name="theme-color" content="#1976d2">

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            background: url("/static/bg.jpg") no-repeat center center fixed;
            background-size: cover;
        }
        h2 { text-align: center; }
        form {
            max-width: 500px; margin: auto; padding: 20px; background-color: white;
            border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .button, select, input[type="submit"], input[list] {
            width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box;
        }
        .button, input[type="submit"] {
            background-color: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;
        }
        .button:hover, input[type="submit"]:hover { background-color: #125ca1; }
        .hidden { display: none; }
        input[list] { border: 1px solid #ccc; border-radius: 4px; }
        @media (max-width: 600px) {
            select, input[list] { font-size: 18px; padding: 12px; }
            option { font-size: 18px; }
        }
    </style>

    <script>
        const pantryOptions = {{ pantry_items|tojson }};
        const serviceOptions = {{ service_items|tojson }};

        function updateFloor(select) {
            if (select.value) {
                select.options[0].text = 'Floor ' + select.value;
                select.options[0].value = select.value;
                select.selectedIndex = 0;
                showPositionFields();
            }
        }

        function showPositionFields() {
            document.getElementById('positions').innerHTML = '';
            document.getElementById('serviceZonePositions').innerHTML = '';
            // Сразу по одному полю на каждую зону
            addItem('positions', 'position_pantry', pantryOptions);
            addItem('serviceZonePositions', 'position_service', serviceOptions);
            document.getElementById('addPositionBtn').style.display = 'block';
            document.getElementById('addServiceZonePositionBtn').style.display = 'block';
            document.getElementById('submitBtn').style.display = 'block';
        }

        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---

        function getInputs(container, fieldName) {
            return Array.from(container.querySelectorAll(`input[name="${fieldName}"]`));
        }

        function getSelectedValues(container, fieldName) {
            return getInputs(container, fieldName)
                .map(i => i.value.trim())
                .filter(Boolean);
        }

        // Пересобрать datalist для конкретного input
        function rebuildDatalistForInput(inputEl, optionsList, excludeValues, query) {
            const listId = inputEl.getAttribute('list');
            const datalist = document.getElementById(listId);
            if (!datalist) return;

            const q = (query || '').trim().toLowerCase();
            datalist.innerHTML = '';

            optionsList.forEach(opt => {
                // оставляем текущее значение, даже если оно "исключено"
                const keepCurrent = inputEl.value && inputEl.value === opt;
                const excluded = excludeValues.includes(opt) && !keepCurrent;
                const matches = q === '' || opt.toLowerCase().includes(q);

                if (!excluded && matches) {
                    const o = document.createElement('option');
                    o.value = opt;
                    datalist.appendChild(o);
                }
            });
        }

        // Обновить ВСЕ остальные поля (кроме sourceInput) — чтобы убрать/вернуть выбранные значения
        function refreshOthers(container, fieldName, optionsList, sourceInput) {
            const inputs = getInputs(container, fieldName);
            const selectedAll = getSelectedValues(container, fieldName);

            inputs.forEach(inp => {
                // Для каждого инпута исключаем все выбранные значения, КРОМЕ его собственного
                const excludeForThis = selectedAll.filter(v => v && v !== inp.value);
                const currentQuery = inp === sourceInput ? sourceInput.value : inp.value;
                rebuildDatalistForInput(inp, optionsList, excludeForThis, currentQuery);
            });
        }

        // --- ГЛАВНАЯ: ДОБАВИТЬ ПОЛЕ С «ЖИВЫМ» ФИЛЬТРОМ (DATALIST) ---

        function addItem(containerId, fieldName, optionsList) {
            const container = document.getElementById(containerId);

            const wrap = document.createElement('div');
            wrap.style.margin = '6px 0 12px 0';

            const listId = `${containerId}-${fieldName}-list-${Date.now()}-${Math.floor(Math.random()*1000)}`;

            const input = document.createElement('input');
            input.setAttribute('list', listId);
            input.setAttribute('name', fieldName);
            input.setAttribute('placeholder', 'Start typing to search…');
            input.style.width = '100%';
            input.style.padding = '10px';
            input.style.boxSizing = 'border-box';
            input.style.border = '1px solid #ccc';
            input.style.borderRadius = '4px';
            input.autocomplete = 'off';

            const datalist = document.createElement('datalist');
            datalist.id = listId;

            // Инициализируем список для нового поля
            const selectedNow = getSelectedValues(container, fieldName);
            rebuildDatalistForInput(input, optionsList, selectedNow, '');

            // ЖИВОЙ фильтр: обновляем datalist по мере ввода
            input.addEventListener('input', () => {
                const selectedLive = getSelectedValues(container, fieldName);
                // исключаем уже выбранные в других полях
                const excludeForThis = selectedLive.filter(v => v && v !== input.value);
                rebuildDatalistForInput(input, optionsList, excludeForThis, input.value);
            });

            // Когда окончательно выбрали значение — обновим остальные поля этой зоны
            input.addEventListener('change', () => {
                refreshOthers(container, fieldName, optionsList, input);
            });

            wrap.appendChild(input);
            wrap.appendChild(datalist);
            container.appendChild(wrap);

            input.focus();
            return false; // чтобы кнопка не делала лишних действий
        }
    </script>
</head>
<body>
    <h2>Select Missing Items</h2>
    <form method="POST" action="/submit">

        <button type="button" onclick="window.location.href='/report'" class="button">Report</button>

        <select id="floorSelect" name="floor" class="button" onchange="updateFloor(this)"
            style="appearance: none; -webkit-appearance: none; text-align: center; text-align-last: center;">
            <option value="">Floor</option>
            {% for floor in floors %}
                <option value="{{ floor }}">{{ floor }}</option>
            {% endfor %}
        </select>

        <h3>Pantry</h3>
        <div id="positions"></div>
        <button type="button" id="addPositionBtn" class="button hidden"
                onclick="return addItem('positions', 'position_pantry', pantryOptions)">
            Add Item
        </button>

        <h3>Service Area</h3>
        <div id="serviceZonePositions"></div>
        <button type="button" id="addServiceZonePositionBtn" class="button hidden"
                onclick="return addItem('serviceZonePositions', 'position_service', serviceOptions)">
            Add Item
        </button>

        <input type="submit" id="submitBtn" value="Save" style="display:none;">
    </form>
</body>
</html>
